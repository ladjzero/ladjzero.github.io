import{r as t,z as e,c as s,a as i,f as r}from"./vendor.f26cfbdc.js";!function(t=".",e="__import__"){try{self[e]=new Function("u","return import(u)")}catch(s){const i=new URL(t,location),r=t=>{URL.revokeObjectURL(t.src),t.remove()};self[e]=t=>new Promise(((s,n)=>{const o=new URL(t,i);if(self[e].moduleMap[o])return s(self[e].moduleMap[o]);const a=new Blob([`import * as m from '${o}';`,`${e}.moduleMap['${o}']=m;`],{type:"text/javascript"}),c=Object.assign(document.createElement("script"),{type:"module",src:URL.createObjectURL(a),onerror(){n(new Error(`Failed to import: ${t}`)),r(c)},onload(){s(self[e].moduleMap[o]),r(c)}});document.head.appendChild(c)})),self[e].moduleMap={}}}("/2048/dist/assets/");let n=0;class o{constructor(t,e){this.ctx=t,this.state=e,this.key=n++}isEqual(t){return this.state===t.state}stage(t){return this.state=t(this.state),this}render(){}}function a(t,e,s=10){return t.beginPath(),t.moveTo(t.x+s,t.y),t.lineTo(t.x+e-s,t.y),t.quadraticCurveTo(t.x+e,t.y,t.x+e,t.y+s),t.lineTo(t.x+e,t.y+e-s),t.quadraticCurveTo(t.x+e,t.y+e,t.x+e-s,t.y+e),t.lineTo(t.x+10,t.y+e),t.quadraticCurveTo(t.x,t.y+e,t.x,t.y+e-s),t.lineTo(t.x,t.y+s),t.quadraticCurveTo(t.x,t.y,t.x+s,t.y),t.fill()}const c=function(t,e){const{x:s,y:i,fillStyle:r,globalAlpha:n}=t;e(t),Object.assign(t,{x:s,y:i,fillStyle:r,globalAlpha:n})};function l(s){return t(e(...s))}class h extends o{isEqual(t){return this.state.sum===t.state.sum}toString(){return String(this.state)}render(){const t=this.ctx;t.fillStyle=t.theme.brick[this.state.sum][0],a(t,t.brickWidth),t.fillStyle=t.theme.brick[this.state.sum][1],t.textAlign="center",t.textBaseline="middle",t.font=t.brickWidth/2+"px sans-serif",t.fillText(String(this.state.sum),t.x+t.brickWidth/2,t.y+t.brickWidth/2)}}class d extends o{resolve(){return null}}class u extends d{layout(t,e){const s=this.ctx;return[s.x+t*s.brickWidth+(t+1)*s.brickMargin,s.y+e*s.brickWidth+(e+1)*s.brickMargin]}resolve(){return this.onResolve&&this.onResolve(),this.state.to}render(){const t=this.ctx,{i:e,j:s}=this.state.from.state,{i:i,j:r}=this.state.to.state,[n,o]=this.layout(e,s),[a,l]=this.layout(i,r);c(t,(()=>{t.x=n+(a-n)*t.transitionProgress,t.y=o+(l-o)*t.transitionProgress,this.state.from.render()}))}}class f extends d{layout(t,e){const s=this.ctx;return[s.x+t*s.brickWidth+(t+1)*s.brickMargin,s.y+e*s.brickWidth+(e+1)*s.brickMargin]}resolve(){return this.state.onResolve&&this.state.onResolve(this),this.state.to}render(){const t=this.ctx,{i:e,j:s}=this.state.from.state,{i:i,j:r}=this.state.to.state,[n,o]=this.layout(e,s),[a,l]=this.layout(i,r);c(t,(()=>{t.x=n+(a-n)*t.transitionProgress,t.y=o+(l-o)*t.transitionProgress,this.state.from.render()})),c(t,(()=>{t.x=a,t.y=l,this.state.to.render()}))}}class g extends d{layout(t,e){const s=this.ctx;return[s.x+t*s.brickWidth+(t+1)*s.brickMargin,s.y+e*s.brickWidth+(e+1)*s.brickMargin]}resolve(){return this.state.onResolve&&this.state.onResolve(this),this.state.to}render(){const t=this.ctx,{i:e,j:s}=this.state.to.state,[i,r]=this.layout(e,s);c(t,(()=>{t.globalAlpha=t.transitionProgress,t.x=i,t.y=r,this.state.to.render()}))}}class F{constructor(t,e){this.ctx=t,this.size=e,this.bricks=new Array(e).fill(null),this.stagedBricks=null;for(let s=0;s<e;s++)this.bricks[s]=new Array(e).fill(null);this.seed(this.bricks,!0)}static from(t,e){const s=function(t){return t.split(/[\n\r|]/).map((t=>(t.trim(),t.split("").map((t=>Number.isNaN(+t)?null:+t)))))}(t),i=new F(e,s.length);for(let r=0;r<s.length;r++)for(let t=0;t<s[0].length;t++)i.bricks[r][t]=s[r][t]?new h(e,{i:r,j:t,sum:s[r][t]}):null;return i}toString(){var t;const e=new Array(this.bricks.length);for(let s=0;s<this.bricks.length;s++)e[s]=new Array(this.bricks.length);for(let s=0;s<this.bricks.length;s++)for(let i=0;i<this.bricks.length;i++)e[s][i]=null==(t=this.bricks[s][i])?void 0:t.toString();return function(t){return t.map((t=>t.map((t=>t||".")).join(""))).join("|")}(e)}seed(t,e){const s=[];for(let i=0;i<this.size;i++)for(let e=0;e<this.size;e++)t[i][e]||s.push([i,e]);if(s.length){const i=Math.round(Math.random()*s.length*100),[r,n]=s[i%s.length];return t[r][n]=e?new h(this.ctx,{i:r,j:n,sum:2**(1+i%2)}):new g(this.ctx,{to:new h(this.ctx,{i:r,j:n,sum:2**(1+i%2)})}),!0}return!1}compact(t){var e;let i,r=!1,n=!1,o=new Map,a=s(this.bricks);const c=new Map;for(let s=0;s<this.size;s++)for(let t=0;t<this.size;t++){const e=this.bricks[s][t];e&&c.set(e.key,e)}switch(t){case"down":a=l(a);case"left":a=l(a);case"up":a=l(a)}do{if(i=!1,"none"!==t){for(let t=this.size-2;t>=0;t--)for(let e=0;e<this.size;e++)a[t][e]&&!a[t+1][e]&&(a[t+1][e]=a[t][e],a[t][e]=null,i=r=!0);if(!n)for(let t=this.size-2;t>=0;t--)for(let s=0;s<this.size;s++)a[t][s]&&a[t+1][s]&&(null==(e=a[t][s])?void 0:e.isEqual(a[t+1][s]))&&(o.set(a[t+1][s].key,new f(this.ctx,{from:c.get(a[t][s].key),to:a[t+1][s],onResolve(t){t.state.to.state.sum*=2}})),a[t][s]=null,i=r=!0,n=!0)}}while(i);switch(t){case"up":a=l(a);case"left":a=l(a);case"down":a=l(a)}if(r){for(let t=0;t<this.size;t++)for(let e=0;e<this.size;e++)a[t][e]&&(a[t][e].state.i=t,a[t][e].state.j=e);for(let t=0;t<this.size;t++)for(let e=0;e<this.size;e++){const s=a[t][e];if(s){const i=o.get(s.key),r=c.get(s.key);i?a[t][e]=i:r&&(a[t][e]=new u(this.ctx,{from:r,to:s}))}}return a}return null}layout(t,e){const s=this.ctx;return[s.x+t*s.brickWidth+(t+1)*s.brickMargin,s.y+e*s.brickWidth+(e+1)*s.brickMargin]}render(){const t=this.ctx;this.ctx.fillStyle=t.theme.gridBackground,a(t,t.gridWidth,20),t.fillStyle=t.theme.brickBackground;const e=new Map;for(let s=0;s<this.size;s++)for(let i=0;i<this.size;i++){c(t,(()=>{t.x=t.x+s*t.brickWidth+(s+1)*t.brickMargin,t.y=t.y+i*t.brickWidth+(i+1)*t.brickMargin,a(t,t.brickWidth)}));const r=this.bricks[s][i];r&&e.set(r.key,[s,i])}if(this.stagedBricks)for(let s=0;s<this.size;s++)for(let e=0;e<this.size;e++){const i=this.stagedBricks[s][e];i instanceof d?c(t,(()=>i.render())):i instanceof h&&c(t,(()=>{[t.x,t.y]=this.layout(s,e),i.render()}))}else for(let s=0;s<this.size;s++)for(let e=0;e<this.size;e++){const i=this.bricks[s][e];i&&c(t,(()=>{[t.x,t.y]=this.layout(s,e),i.render()}))}}}var k={gridBackground:"#A59482",brickBackground:"#BFAE9E",brick:{2:["#F1E7DF","#736C5F"],4:["#F1E7DF","#736C5F"],8:["#F1B17E","#FFFFFF"],16:["#F7966A","#FFFFFF"],32:["#F47F67","#FFFFFF"],64:["#F75F4F","#FFFFFF"],128:["#EFD697","#FFFFFF"],256:["#F2CC67","#FFFFFF"],512:["#EBC56F","#FFFFFF"],1024:["#EEC351","#FFFFFF"],2048:["#EEC241","#FFFFFF"],4096:["#EEC241","#FFFFFF"]}};const b=devicePixelRatio,m=new Audio("/2048/dist/assets/bubble.378e5a32.mov"),y=document.getElementById("app"),x=y.getContext("2d");let w=new F(x,4);console.log(w);let p=0,v=!1;!function(t){let e=0,s=0,i=!1,r="none";const n=e=>{t.next(r,e),r="none",requestAnimationFrame(n)};n(Date.now()),document.addEventListener("touchstart",(t=>{if(1===t.touches.length){i=!0;const r=t.touches[0];e=r.clientX,s=r.clientY}else i=!1})),document.addEventListener("touchmove",(t=>t.preventDefault()),{passive:!1}),document.addEventListener("touchend",(t=>{const n=t.changedTouches[0];if(n&&i){const t=n.clientX-e,i=n.clientY-s;Math.abs(t)>10&&Math.abs(t)>Math.abs(i)?r=t>0?"right":"left":Math.abs(i)>10&&Math.abs(t)<Math.abs(i)&&(r=i>0?"down":"up")}})),document.addEventListener("keyup",(t=>{switch(t.code){case"ArrowUp":r="up";break;case"ArrowRight":r="right";break;case"ArrowDown":r="down";break;case"ArrowLeft":r="left"}}))}({next(t,e){if(v){if("none"!==t&&!p&&(p=e,w.stagedBricks=w.compact(t),w.stagedBricks&&(m.play(),!w.seed(w.stagedBricks))))throw alert("failed"),Error("exit");if(p&&e-p>200){if(p=0,w.stagedBricks){w.bricks=i(r(w.stagedBricks).map((t=>t instanceof d?t.resolve():t)),4);["up","right","down","left"].every((t=>!w.compact(t)))&&setTimeout((()=>{confirm("无法继续，重新开始？")&&(w=new F(x,4))}),1e3)}w.stagedBricks=null}p&&(x.transitionProgress=(e-p)/200),w.render()}}});const M=()=>{x.theme=k,x.x=0,x.y=0;const{width:t,height:e}=y.getBoundingClientRect();x.width=y.width=t*b,x.height=y.height=e*b,x.gridWidth=Math.floor(.8*Math.min(x.width,x.height));x.brickMargin=x.gridWidth/41,x.brickWidth=9*x.brickMargin,x.x=(x.width-x.gridWidth)/2,x.y=(x.height-x.gridWidth)/2,c(x,(()=>w.render())),v=!0};window.addEventListener("load",M),window.addEventListener("resize",M);
