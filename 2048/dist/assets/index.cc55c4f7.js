import{r as t,z as e,c as s,f as i,a as n}from"./vendor.58d9e7e0.js";!function(t=".",e="__import__"){try{self[e]=new Function("u","return import(u)")}catch(s){const i=new URL(t,location),n=t=>{URL.revokeObjectURL(t.src),t.remove()};self[e]=t=>new Promise(((s,r)=>{const o=new URL(t,i);if(self[e].moduleMap[o])return s(self[e].moduleMap[o]);const h=new Blob([`import * as m from '${o}';`,`${e}.moduleMap['${o}']=m;`],{type:"text/javascript"}),a=Object.assign(document.createElement("script"),{type:"module",src:URL.createObjectURL(h),onerror(){r(new Error(`Failed to import: ${t}`)),n(a)},onload(){s(self[e].moduleMap[o]),n(a)}});document.head.appendChild(a)})),self[e].moduleMap={}}}("/2048/dist/assets/");let r=0;class o{constructor(t,e){this.ctx=t,this.state=e,this.key=r++}layout(){const{x:t,y:e,w:s,h:i}=this.ctx;return{x:t,y:e,w:s,h:i}}isEqual(t){return this.state===t.state}stage(t){return this.state=t(this.state),this}render(){}}function h(t,e=10){return t.beginPath(),t.moveTo(t.x+e,t.y),t.lineTo(t.x+t.w-e,t.y),t.quadraticCurveTo(t.x+t.w,t.y,t.x+t.w,t.y+e),t.lineTo(t.x+t.w,t.y+t.w-e),t.quadraticCurveTo(t.x+t.w,t.y+t.w,t.x+t.w-e,t.y+t.w),t.lineTo(t.x+10,t.y+t.w),t.quadraticCurveTo(t.x,t.y+t.w,t.x,t.y+t.w-e),t.lineTo(t.x,t.y+e),t.quadraticCurveTo(t.x,t.y,t.x+e,t.y),t.fill()}const a=function(t,e){const{x:s,y:i,w:n,h:r,fillStyle:o,globalAlpha:h}=t;e(t),Object.assign(t,{x:s,y:i,w:n,h:r,fillStyle:o,globalAlpha:h})};function l(s){return t(e(...s))}function c(t,e){const i=s(t,Math.sqrt(t.length));for(let s=0;s<i.length;s++){const t=i[s];for(let n=0;n<t.length&&!e(t[n],s,n,s*i.length+n);n++);}}class d extends o{isEqual(t){return this.state.sum===t.state.sum}toString(){return String(this.state.sum)}layout(){const t=this.ctx,{i:e,j:s}=this.state;return{x:t.x+e*t.brickWidth+(e+1)*t.brickMargin,y:t.y+s*t.brickWidth+(s+1)*t.brickMargin,w:t.brickWidth,h:t.brickWidth}}render(){const t=this.ctx;t.fillStyle=t.theme.brick[this.state.sum][0],h(t),t.fillStyle=t.theme.brick[this.state.sum][1],t.textAlign="center",t.textBaseline="middle",t.font=t.brickWidth/2+"px sans-serif",t.fillText(String(this.state.sum),t.x+t.brickWidth/2,t.y+t.brickWidth/2)}}class u extends o{resolve(){return null}}class g extends u{resolve(){return this.onResolve&&this.onResolve(),this.state.to}render(){const t=this.ctx,{x:e,y:s,w:i,h:n}=this.state.from.layout(),{x:r,y:o}=this.state.to.layout();t.x=e+(r-e)*t.transitionProgress,t.y=s+(o-s)*t.transitionProgress,t.w=i,t.h=n,this.state.from.render()}}class F extends u{resolve(){return this.state.onResolve&&this.state.onResolve(this),this.state.to}render(){const t=this.ctx,{x:e,y:s,w:i,h:n}=this.state.from.layout(),{x:r,y:o}=this.state.to.layout();t.x=e+(r-e)*t.transitionProgress,t.y=s+(o-s)*t.transitionProgress,t.w=i,t.h=n,this.state.from.render(),t.x=r,t.y=o,this.state.to.render()}}class f extends u{resolve(){return this.state.onResolve&&this.state.onResolve(this),this.state.to}render(){const t=this.ctx,{x:e,y:s,w:i,h:n}=this.state.to.layout();t.globalAlpha=t.transitionProgress,t.x=e,t.y=s,t.w=i,t.h=n,this.state.to.render()}}class w extends o{constructor(t,e){super(t,e),this.ctx=t,this.size=e,this.children=new Array(e*e).fill(null),this.stagedChildren=null,this.seed(this.children,!0)}static from(t,e){const s=function(t){return t.split(/[\n\r|]/).map((t=>(t.trim(),t.split("").map((t=>Number.isNaN(+t)?null:+t)))))}(t),n=new w(e,s.length);return c(i(s),((t,s,i,r)=>{n.children[r]=t?new d(e,{i:s,j:i,sum:t}):null})),console.log("from",t,n.toString()),n}resolve(){this.stagedChildren&&(this.children=this.stagedChildren.map((t=>t instanceof u?t.resolve():t)),this.stagedChildren=null)}toString(){const t=this.children.map((t=>t?+t.toString():null));return function(t){return t.map((t=>t.map((t=>t||".")).join(""))).join("|")}(s(t,Math.sqrt(t.length)))}seed(t,e){const s=[];if(c(t,((t,e,i,n)=>{t||s.push([e,i,n])})),s.length){const i=Math.round(Math.random()*s.length*100),[n,r,o]=s[i%s.length];return t[o]=e?new d(this.ctx,{i:n,j:r,sum:2**(1+i%2)}):new f(this.ctx,{to:new d(this.ctx,{i:n,j:r,sum:2**(1+i%2)})}),!0}return!1}compact(t){let e,r=!1,o=new Map,h=s(n(this.children),Math.sqrt(this.children.length));const a=new Map,d=new Set;switch(c(this.children,(t=>{t&&a.set(t.key,t)})),t){case"down":h=l(h);case"left":h=l(h);case"up":h=l(h)}do{if(e=!1,"none"!==t){for(let t=this.size-2;t>=0;t--)for(let s=0;s<this.size;s++)h[t][s]&&!h[t+1][s]&&(h[t+1][s]=h[t][s],h[t][s]=null,e=r=!0);for(let t=this.size-2;t>=0;t--)for(let s=0;s<this.size;s++){const i=h[t][s],n=h[t+1][s];i&&n&&i.isEqual(n)&&!d.has(i.key)&&!d.has(n.key)&&(d.add(i.key),d.add(n.key),o.set(n.key,new F(this.ctx,{from:a.get(i.key),to:n,onResolve(t){t.state.to.state.sum*=2}})),h[t][s]=null,e=r=!0)}}}while(e);switch(t){case"up":h=l(h);case"left":h=l(h);case"down":h=l(h)}if(r){for(let t=0;t<this.size;t++)for(let e=0;e<this.size;e++)h[t][e]&&(h[t][e].state.i=t,h[t][e].state.j=e);for(let t=0;t<this.size;t++)for(let e=0;e<this.size;e++){const s=h[t][e];if(s){const i=o.get(s.key),n=a.get(s.key);i?h[t][e]=i:n&&(h[t][e]=new g(this.ctx,{from:n,to:s}))}}return i(h)}return null}layout(){const t=this.ctx;return{x:(t.width-t.gridWidth)/2,y:(t.height-t.gridWidth)/2,w:t.gridWidth,h:t.gridWidth}}render(){const t=this.ctx;this.ctx.fillStyle=t.theme.gridBackground,h(t,20),t.fillStyle=t.theme.brickBackground,c(this.children,((e,s,i)=>{a(t,(()=>{t.x=t.x+s*t.brickWidth+(s+1)*t.brickMargin,t.y=t.y+i*t.brickWidth+(i+1)*t.brickMargin,t.w=t.brickWidth,t.h=t.brickWidth,h(t)}))}))}}var m={gridBackground:"#A59482",brickBackground:"#BFAE9E",brick:{2:["#F1E7DF","#736C5F"],4:["#F1E7DF","#736C5F"],8:["#F1B17E","#FFFFFF"],16:["#F7966A","#FFFFFF"],32:["#F47F67","#FFFFFF"],64:["#F75F4F","#FFFFFF"],128:["#EFD697","#FFFFFF"],256:["#F2CC67","#FFFFFF"],512:["#EBC56F","#FFFFFF"],1024:["#EEC351","#FFFFFF"],2048:["#EEC241","#FFFFFF"],4096:["#EEC241","#FFFFFF"]}};let y=4;const x=devicePixelRatio,p=new Audio("/2048/dist/assets/bubble.378e5a32.mov"),b=document.getElementById("app"),k=b.getContext("2d"),v=new class{constructor(t){this.ctx=t}render(t){const e=this.ctx;a(e,(()=>{const{x:s,y:i,w:n,h:r}=t.layout();if(e.x=s,e.y=i,e.w=n,e.h=r,t.render(),t.stagedChildren)for(let e of t.stagedChildren)e&&this.render(e);else if(t.children)for(let e of t.children)e&&this.render(e)}))}}(k);let E,C=0,M=!1;!function(t){let e=0,s=0,i=!1,n="none";const r=document.getElementById("app"),o=e=>{t.next(n,e),n="none",requestAnimationFrame(o)};o(Date.now()),r.addEventListener("touchstart",(t=>{if(1===t.touches.length){i=!0;const n=t.touches[0];e=n.clientX,s=n.clientY}else i=!1})),r.addEventListener("touchmove",(t=>t.preventDefault()),{passive:!1}),r.addEventListener("touchend",(t=>{const r=t.changedTouches[0];if(r&&i){const t=r.clientX-e,i=r.clientY-s;Math.abs(t)>10&&Math.abs(t)>Math.abs(i)?n=t>0?"right":"left":Math.abs(i)>10&&Math.abs(t)<Math.abs(i)&&(n=i>0?"down":"up")}})),document.addEventListener("keyup",(t=>{switch(t.code){case"ArrowUp":n="up";break;case"ArrowRight":n="right";break;case"ArrowDown":n="down";break;case"ArrowLeft":n="left"}}))}({next(t,e){if(M){if("none"!==t&&!C&&(C=e,E.stagedChildren=E.compact(t),E.stagedChildren&&(p.play(),!E.seed(E.stagedChildren))))throw alert("failed"),Error("exit");if(C&&e-C>200){if(C=0,E.stagedChildren){E.children=E.stagedChildren.map((t=>t instanceof u?t.resolve():t));["up","right","down","left"].every((t=>!E.compact(t)))&&setTimeout((()=>{confirm("无法继续，重新开始？")&&(E=new w(k,4))}),1e3)}E.stagedChildren=null}C&&(k.transitionProgress=(e-C)/200),v.render(E)}}});const W=()=>{E=new w(k,y);const{width:t,height:e}=b.getBoundingClientRect();k.theme=m,k.x=0,k.y=0,k.width=b.width=t*x,k.height=b.height=e*x,k.w=k.width,k.h=k.height,k.gridWidth=Math.floor(.8*Math.min(k.width,k.height)),k.brickMargin=k.gridWidth/(10*y+1),k.brickWidth=9*k.brickMargin,a(k,(()=>v.render(E))),M=!0};document.getElementById("size").addEventListener("change",(t=>{y=Number(t.target.value)||4,W()})),window.addEventListener("load",W),window.addEventListener("resize",W);
